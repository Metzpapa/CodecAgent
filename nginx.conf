# nginx.conf

# Define an 'upstream' block for the backend service. This makes the configuration
# cleaner and allows for potential load balancing in the future.
upstream backend_service {
    # 'backend' is the service name defined in docker-compose.yml
    # '8000' is the port the FastAPI app is exposed on inside the Docker network
    server backend:8000;
}

server {
    # Nginx will listen on port 80 for incoming HTTP traffic.
    # Cloudflare will handle HTTPS and forward traffic to this port.
    listen 80;

    # Replace this with your actual domain name.
    server_name trycodec.ai;

    # Set a higher limit for client request bodies to allow for large file uploads.
    # 500M is a generous starting point; adjust as needed.
    client_max_body_size 500M;

    # --- MODIFIED LOCATION BLOCK ---
    # Location block for all API requests.
    # Any request starting with '/api/' will be handled here. This creates a
    # clear namespace for the backend and prevents conflicts with frontend routes.
    location /api/ {
        # Pass the request to our defined upstream service.
        # The full request URI (e.g., /api/jobs/some-id/status) is passed along
        # to the FastAPI backend, which now expects the /api prefix.
        proxy_pass http://backend_service;

        # Set headers to pass along important information to the FastAPI backend.
        # This ensures the backend knows the original host, user IP, and protocol.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Location block for serving the static React frontend.
    # This is the catch-all block for any request that doesn't match the API location.
    location / {
        # The root directory where the built React files are located.
        # This path corresponds to the volume mount in docker-compose.yml.
        root /usr/share/nginx/html;

        # This is the key for Single Page Application (SPA) routing.
        # 1. Nginx first tries to find a file matching the exact request URI ($uri).
        # 2. If that fails, it checks if the URI is a directory ($uri/).
        # 3. If both fail, it serves /index.html, allowing React Router to handle the route.
        #    This now correctly handles reloads on pages like /jobs/some-id.
        try_files $uri $uri/ /index.html;
    }
}